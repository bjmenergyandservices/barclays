<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barclays Online Banking</title>
    <!--favicon-->
    <link rel="icon" type="image/x-icon" href="./assets/vendor/favicon_io/favicon-32x32.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!--vendor-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css">
    
    <!--main-->
    <link rel="stylesheet" href="./assets/css/main.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo" onclick="showHomePage()">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                        viewBox="0 0 278.41 300" style="height: 30px;" xml:space="preserve">
                    <style type="text/css">
                        .st0{fill:#00AEEF;}
                    </style>
                    <g id="Logo__x26__Wordmark">
                        <path class="st0" d="M277.64,103.3c1.36,14.21,0.69,26.1-0.24,36.83c-1.56,17.98-4.56,28.74-8.89,40.26
                            c-4.47,11.93-9.94,23.31-15.81,32.92l-0.35,0.58c-1.88,3.07-3.26,5.32-4.04,6.37c-0.13-0.15-0.28-0.31-0.45-0.49
                            c-0.71-0.74-1.77-1.85-3.41-3.48c-2.4-2.4-9.12-11.18-11.01-13.88c-1.67-2.36-5.34-7.94-7.33-12.17l-1.02-2.17l-1.88,1.48
                            c-2,1.59-3.17,4.35-3.12,7.41c0.04,2.69,0.66,5.81,2.29,11.51c1.79,6.22,4.92,13.65,8.56,20.38c0.44,0.83,0.89,1.64,1.31,2.39
                            c2.51,4.5,3.48,6.57,2.29,7.43c-0.19,0.14-0.42,0.16-0.55,0.16c-1.49,0-4.23-1.42-7.35-3.8c-2.77-2.11-10.19-8.39-19.18-20.94
                            c-6.78-9.5-12.16-18.71-17.45-29.87l-0.78-1.64c0,0-1.14,0.4-2.19,1.05c-0.74,0.45-1.36,0.98-1.79,1.77
                            c-1.03,1.85-1.36,4.29-1.01,7.07c0.82,6.68,4.74,16.88,7.9,24.24c5.34,12.43,15.16,26.41,22.46,35.95
                            c0.28,0.37,0.62,0.76,0.96,1.16c0.38,0.46,1.03,1.21,1.35,1.71c-0.64,0.65-2.13,1.86-3.93,3.35l-2.69,2.19
                            c-9.83,8.1-19.43,14.62-31.1,21.14c-9.12,5.1-27.68,14.52-39.98,17.81c-12.31-3.29-30.86-12.71-39.98-17.81
                            c-11.81-6.59-21.11-12.92-31.11-21.14l-2.76-2.25c-1.8-1.47-3.28-2.69-3.89-3.32c0.29-0.36,2.05-2.47,2.34-2.83
                            c7.29-9.52,17.11-23.49,22.46-35.95c3.15-7.35,7.09-17.52,7.92-24.25c0.35-2.78,0-5.21-1.02-7.05c-0.52-0.94-1.39-1.72-2.31-2.12
                            l-1.67-0.7l-0.78,1.64c-5.29,11.15-10.68,20.37-17.45,29.87c-8.96,12.54-16.39,18.82-19.17,20.94c-3.07,2.35-5.88,3.8-7.35,3.8
                            c-0.13,0-0.36-0.01-0.47-0.1l-0.27-0.22c-0.9-0.95,0.12-3.03,2.5-7.3c0.42-0.76,0.85-1.54,1.3-2.36
                            c3.64-6.74,6.75-14.17,8.54-20.37c1.64-5.72,2.26-8.84,2.3-11.52c0.05-3.05-1.12-5.82-3.13-7.41l-1.88-1.48l-1.01,2.17
                            c-1.85,3.95-5.4,9.44-7.33,12.17c-1.91,2.71-8.64,11.51-11.01,13.88c-1.64,1.64-2.7,2.75-3.41,3.5c-0.17,0.18-0.32,0.33-0.45,0.47
                            c-0.8-1.08-2.25-3.44-4.23-6.67c-6.04-9.88-11.51-21.26-15.97-33.19c-4.33-11.53-7.33-22.29-8.89-40.26
                            c-0.94-10.79-1.62-22.73-0.24-36.86c1.39-14.42,5-28.03,10.17-38.33c7.3-14.57,16.4-23.2,27.8-26.4c2.86-0.8,7.31-1.75,12.34-1.75
                            c9.06,0,16.29,2.98,21.5,8.86c2.89,3.24,4.02,8.18,2.9,12.58c-1.01,3.95-3.78,6.52-7.47,8.25c-0.95,0.45-2.04,0.72-2.04,0.72
                            s0.12,0.51,1.09,2.09c3.64,5.87,10.73,8.95,20.47,8.95c2.27,0,4.64-0.17,7.04-0.5c13.86-1.93,20.1-10.68,22.38-27.53
                            c0.89-6.58,1.74-12.11-2.5-18.95c-2.97-4.8-11.45-7.63-17.65-7.61c-5.55,0.03-8.48,1.47-10.25,3.32c-0.08-0.27-0.47-0.73-0.57-0.98
                            c-0.63-1.5-1.19-3.2-0.64-6.24c0.65-3.6,3.51-6.97,5.02-8.16c3.23-2.59,6.88-5.05,12.79-6.29c2.8-0.59,5.75-1.12,9.06-1.12
                            c0.7,0,3.05-0.01,4.1,0.07c0.46,0.03,0.53-0.17,0.86-0.58c2.03-2.45,5.22-3.79,11.03-3.66c4.47,0.1,10.43,0.33,15.12,1.83
                            c4.17,1.34,6.28,2.62,8.71,4.2c2.82,1.82,5.75,5.64,7,9.28c1.86,5.43,2.93,12.19,3.21,20c0.32,15.56,2.53,25.01,6.89,30.64
                            c7.03,9.08,13.04,10.98,20.3,11.44l0.79,0.01c13.71,0,18.71-4.34,20.94-7.65c0,0,1.21-1.7,1.71-2.67
                            c-1.74-0.32-2.85-0.73-2.85-0.73c-3.49-1.31-5.96-4.1-6.97-7.86c-1.21-4.48-0.12-9.39,2.82-12.81c6.5-7.55,16.18-8.78,21.36-8.85
                            l0.59,0c4.06,0,8.02,0.6,11.77,1.79c5.11,1.61,9.53,3.88,13.15,6.75c7.11,5.69,11.6,13.46,14.71,19.58
                            C272.57,74.99,276.38,89.33,277.64,103.3z"/>
                    </g>
                    <g id="Clearspace">
                    </g>
                    </svg>
            </a>
            <div id="userMenu">
                <a id="adminLoginBtn" class="admin-vanish" onclick="showAdminLogin()" style="display: none;"><i class="bi bi-person-fill"></i></a>
                <button id="logoutBtn" class="btn btn-secondary" onclick="logoutUser()" style="display: none;">Logout</button>
            </div>
        </div>
    </header>

    <!-- Registration Form -->
    <div id="registrationSection" class="container">
        <div class="form-section">
            <div class="form-header">
                <h1>Register for Online Banking</h1>
                <p>It only takes a few minutes</p>
            </div>
            
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Your Details</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Review</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>
            
            <!-- Step 1: Your Details -->
            <div id="step1Form">
                <div class="form-group">
                    <label>Last name</label>
                    <input type="text" id="lastName" required>
                </div>
                
                <div class="form-group">
                    <label>Date of birth (DD/MM/YYYY)</label>
                    <div class="date-inputs">
                        <input type="number" id="birthDay" placeholder="DD" min="1" max="31" required>
                        <input type="number" id="birthMonth" placeholder="MM" min="1" max="12" required>
                        <input type="number" id="birthYear" placeholder="YYYY" min="1900" max="2025" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Postcode</label>
                    <input type="text" id="postcode" required>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="cancelRegistration()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="nextStep(2)">Next</button>
                </div>
            </div>
            
            <!-- Step 2: Account Details -->
            <div id="step2Form" class="hidden">
                <div class="form-group">
                    <label>Select the type of account you have</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="accountCurrent" name="accountType" value="current" checked>
                            <label for="accountCurrent">Current or savings account</label>
                            <div class="radio-description">
                                If you have a mortgage with us, as well as a current or savings account, choose this option.
                            </div>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="accountMortgage" name="accountType" value="mortgage">
                            <label for="accountMortgage">Mortgage account</label>
                            <div class="radio-description">
                                If you only have a mortgage account with us, choose this option.
                            </div>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="accountMerchant" name="accountType" value="merchant">
                            <label for="accountMerchant">Merchant</label>
                            <div class="radio-description">
                                If you're a merchant customer and you don't have any other accounts with us, choose this option.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Sort code</label>
                    <input type="text" id="sortCode" placeholder="20-00-00" required pattern="[0-9]{2}-[0-9]{2}-[0-9]{2}">
                    <small style="color: var(--barclays-gray); margin-top: 5px; display: block;">
                        This is the 6-digit number on the front of your debit or authentication card.
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Card number (16 digits)</label>
                    <input type="text" id="cardNumber" minlength="16" maxlength="16" required pattern="[0-9]{16}">
                    <small style="color: var(--barclays-gray); margin-top: 5px; display: block;">
                        This is the 16-digit number on the front of your debit or authentication card.
                    </small>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="prevStep(1)">Back</button>
                    <button type="button" class="btn btn-primary" onclick="nextStep(3)">Next</button>
                </div>
            </div>
            
            <!-- Step 3: Contact Details & Password -->
            <div id="step3Form" class="hidden">
                <div class="form-group">
                    <label>Email address</label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group">
                    <label>Confirm Email address</label>
                    <input type="email" id="confirmEmail" required>
                </div>
                
                <div class="form-group">
                    <label>Create Password (for demo purposes)</label>
                    <input type="password" id="password" minlength="6" required>
                    <small style="color: var(--barclays-gray); margin-top: 5px; display: block;">
                        For this demo system, create a password to secure your account.
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="confirmPassword" minlength="6" required>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="marketingOptIn">
                    <label for="marketingOptIn" style="font-weight: normal;">
                        From time to time, we'll email you information about our products and services, 
                        and those of third parties. If you'd rather we didn't, please tick this box.
                    </label>
                </div>
                
                <div id="registerAlert" class="alert"></div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="prevStep(2)">Back</button>
                    <button type="button" class="btn btn-primary" onclick="registerUser()">Complete Registration</button>
                </div>
            </div>
        </div>
        
        <!-- FAQ Section -->
        <div class="faq-section">
            <h3>Frequently asked questions</h3>
            <ul class="faq-list">
                <li>How to reset your memorable word and passcode</li>
                <li>Is saving my details safe?</li>
                <li>Service status</li>
                <li>What does error code 6 mean?</li>
                <li>How do I login with Mobile PINsentry?</li>
            </ul>
            <div style="margin-top: 20px;">
                <a href="#" class="btn btn-link">Need more help?</a>
            </div>
        </div>
    </div>

    <!-- Login Form -->
    <div id="loginSection" class="container hidden">
        <div class="form-header-main">
            <p>Log in to Online Banking</p>   
        </div>
        <div class="form-section">
            <div class="form-header-sub">
                <p class="sub">How would you like to login?</p>
                <p>Not registered for Online Banking? <a href="#" onclick="showRegistration()" style="color: var(--barclays-blue);">Register now</a></p>
            </div>
            
            <!-- Login Options -->
            <div class="login-options">
                <button class="login-option active" onclick="showLoginMethod('membership')">Membership number</button>
                <button class="login-option" onclick="showLoginMethod('card')">Card number</button>
                <button class="login-option" onclick="showLoginMethod('sortcode')">Sort code and account number</button>
            </div>
            
            <!-- Membership Number Login -->
            <div id="membershipLogin" class="login-method">
                <div class="form-group">
                    <label>Last name</label>
                    <input type="text" id="loginLastName">
                </div>
                
                <div class="form-group">
                    <label>Membership number (12 digits)</label>
                    <input type="text" id="membershipNumber" minlength="12" maxlength="12" pattern="[0-9]{12}">
                    <small style="color: var(--barclays-gray); margin-top: 5px; display: block;">
                        <a href="#" style="color: var(--barclays-blue);">Don't know your membership number?</a>
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Password (for demo)</label>
                    <input type="password" id="membershipPassword">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberMembership">
                    <label for="rememberMembership" style="font-weight: normal;">
                        Remember my last name and login method (optional)<br>
                        <small style="color: var(--barclays-gray);">Don't tick the box if you're using a public or shared device.</small>
                    </label>
                </div>
                
                <div id="loginAlert" class="alert"></div>
                
                <button type="button" class="loginbtn" onclick="loginWithMembership()">Continue</button>
            </div>
            
            <!-- Card Number Login -->
            <div id="cardLogin" class="login-method hidden">
                <div class="form-group">
                    <label>Last name</label>
                    <input type="text" id="cardLastName">
                </div>
                
                <div class="form-group">
                    <label>Card number (16 digits)</label>
                    <input type="text" id="loginCardNumber" minlength="16" maxlength="16" pattern="[0-9]{16}">
                </div>
                
                <div class="form-group">
                    <label>Password (for demo)</label>
                    <input type="password" id="cardPassword">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberCard">
                    <label for="rememberCard" style="font-weight: normal;">
                        Remember my last name and login method (optional)<br>
                        <small style="color: var(--barclays-gray);">Don't tick the box if you're using a public or shared device.</small>
                    </label>
                </div>
                
                <button type="button" class="loginbtn" onclick="loginWithCard()">Continue</button>
            </div>
            
            <!-- Sort Code Login -->
            <div id="sortcodeLogin" class="login-method hidden">
                <div class="form-group">
                    <label>Last name</label>
                    <input type="text" id="sortcodeLastName">
                </div>
                
                <div class="form-group">
                    <label>Sort code</label>
                    <input type="text" id="loginSortCode" placeholder="20-00-00" pattern="[0-9]{2}-[0-9]{2}-[0-9]{2}">
                </div>
                
                <div class="form-group">
                    <label>Account number</label>
                    <input type="text" id="accountNumber" minlength="8" maxlength="8" pattern="[0-9]{8}">
                </div>
                
                <div class="form-group">
                    <label>Password (for demo)</label>
                    <input type="password" id="sortcodePassword">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberSortcode">
                    <label for="rememberSortcode" style="font-weight: normal;">
                        Remember my last name and login method (optional)<br>
                        <small style="color: var(--barclays-gray);">Don't tick the box if you're using a public or shared device.</small>
                    </label>
                </div>
                
                <button type="button" class="loginbtn" onclick="loginWithSortcode()">Continue</button>
            </div>
        </div>
        
        <!-- FAQ Section -->
        <div class="faq-section">
            <h3>Frequently asked questions</h3>
            <ul class="faq-list">
                <li>How to reset your memorable word and passcode</li>
                <li>Is saving my details safe?</li>
                <li>Service status</li>
                <li>What does error code 6 mean?</li>
                <li>How do I login with Mobile PINsentry?</li>
            </ul>
            <div style="margin-top: 20px;">
                <button href="#" class="faq-btn">Need more help?</button>
            </div>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="dashboardSection" class="dashboard hidden">
        <div class="dashboard-header">
            <h1>Welcome, <span id="welcomeName"></span></h1>
            <p>Account number: <span id="dashboardAccountNumber" class="account-number"></span></p>
        </div>
        
        <!-- Account Details Card -->
        <div class="account-details-card">
            <h3 style="color: white; margin-bottom: 20px;">Account Details</h3>
            <div class="account-details-row">
                <span>Account Holder:</span>
                <span id="accountHolderName"></span>
            </div>
            <div class="account-details-row">
                <span>Account Number:</span>
                <span id="fullAccountNumber"></span>
            </div>
            <div class="account-details-row">
                <span>Sort Code:</span>
                <span id="fullSortCode"></span>
            </div>
            <div class="account-details-row">
                <span>IBAN:</span>
                <span id="ibanNumber"></span>
                <button class="copy-btn" onclick="copyToClipboard('ibanNumber')">Copy</button>
            </div>
            <div class="account-details-row">
                <span>SWIFT/BIC:</span>
                <span id="swiftCode"></span>
                <button class="copy-btn" onclick="copyToClipboard('swiftCode')">Copy</button>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="showAccountDetailsReceipt()">View Account Details Receipt</button>
            </div>
        </div>
        
        <div class="account-summary">
            <div class="summary-card">
                <h3>Available Balance</h3>
                <div class="balance">¬£<span id="currentBalance">0.00</span></div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary btn-sm" onclick="showWithdrawModal()">Withdraw</button>
                </div>
            </div>
            
            <div class="summary-card">
                <h3>Account Type</h3>
                <div id="accountTypeDisplay" style="font-size: 24px; font-weight: bold; color: var(--barclays-dark);"></div>
            </div>
            
            <div class="summary-card">
                <h3>Card Number</h3>
                <div id="cardNumberDisplay" style="font-family: monospace; font-size: 18px; color: var(--barclays-dark);"></div>
            </div>
            
            <div class="summary-card">
                <h3>Quick Actions</h3>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-secondary btn-sm" onclick="showTransferModal()">Make Transfer</button>
                    <button class="btn btn-secondary btn-sm" onclick="requestATMCard()">Request ATM Card</button>
                    <button class="btn btn-secondary btn-sm" onclick="showStatements()">View Statements</button>
                </div>
            </div>
        </div>
        
        <!-- ATM Card Request Section -->
        <div class="atm-card-request">
            <h3>üîí ATM Card Services</h3>
            <p>Need a new ATM card or have issues with your current card?</p>
            <button class="btn btn-primary" onclick="requestATMCard()">Request ATM Card Support</button>
        </div>
        
        <!-- Recent Transactions -->
        <div class="summary-card" style="margin-top: 30px;">
            <h3>Recent Transactions</h3>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="transactionList">
                    <!-- Transactions will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminSection" class="admin-panel hidden">
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <div>
                <button class="btn btn-secondary" onclick="showRegistration()">View Registration</button>
                <button class="btn btn-danger" onclick="logoutAdmin()">Logout Admin</button>
            </div>
        </div>
        
        <!-- Admin Controls Panel -->
        <div class="admin-controls-panel">
            <h3>Admin Controls</h3>
            <div class="admin-buttons">
                <button class="btn btn-success" onclick="showCreateAccountModal()">‚ûï Create User Account</button>
                <button class="btn btn-primary" onclick="refreshAdminUsers()">üîÑ Refresh Users</button>
                <button class="btn btn-warning" onclick="exportUsersToCSV()">üìä Export CSV</button>
                <button class="btn btn-secondary" onclick="viewSystemLogs()">üìã View System Logs</button>
            </div>
        </div>
        
        <div class="form-section">
            <h2>All Registered Users <small>(Full Details)</small></h2>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Account Type</th>
                        <th>Sort Code</th>
                        <th>Card Number</th>
                        <th>Account No.</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminUsersList">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Transfer Money</h3>
            
            <!-- Transfer Type Selection -->
            <div class="transfer-options">
                <div class="transfer-option-btn active" onclick="selectTransferType('domestic')" id="domesticTransferBtn">
                    <h4>üá¨üáß Domestic</h4>
                    <p>Within UK</p>
                </div>
                <div class="transfer-option-btn" onclick="selectTransferType('international')" id="internationalTransferBtn">
                    <h4>üåç International</h4>
                    <p>Outside UK</p>
                </div>
            </div>
            
            <!-- Domestic Transfer Form -->
            <div id="domesticTransferForm">
                <div class="form-group">
                    <label>Recipient Name</label>
                    <input type="text" id="modalRecipientName" placeholder="Full name of recipient">
                </div>
                
                <div class="form-group">
                    <label>Recipient Sort Code</label>
                    <input type="text" id="modalRecipientSortCode" placeholder="20-00-00" pattern="[0-9]{2}-[0-9]{2}-[0-9]{2}">
                </div>
                
                <div class="form-group">
                    <label>Recipient Account Number</label>
                    <input type="text" id="modalRecipientAccountNumber" minlength="8" maxlength="8" pattern="[0-9]{8}" placeholder="8-digit account number">
                </div>
                
                <div class="form-group">
                    <label>Amount (¬£)</label>
                    <input type="number" id="modalTransferAmount" min="0.01" step="0.01" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label>Reference (Optional)</label>
                    <input type="text" id="modalTransferReference" placeholder="e.g., Rent payment">
                </div>
            </div>
            
            <!-- International Transfer Form -->
            <div id="internationalTransferForm" class="hidden">
                <div class="international-fields">
                    <div class="form-group">
                        <label>Recipient Full Name</label>
                        <input type="text" id="intRecipientName" placeholder="As per bank account">
                    </div>
                    
                    <div class="form-group">
                        <label>Recipient Bank Name</label>
                        <input type="text" id="intBankName" placeholder="Recipient's bank name">
                    </div>
                    
                    <div class="form-group">
                        <label>Recipient Bank Address</label>
                        <textarea id="intBankAddress" placeholder="Bank street address, city, country" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Recipient Account Number/IBAN</label>
                        <input type="text" id="intAccountNumber" placeholder="Account number or IBAN">
                    </div>
                    
                    <div class="form-group">
                        <label>SWIFT/BIC Code</label>
                        <input type="text" id="intSwiftCode" placeholder="11-character SWIFT code">
                    </div>
                    
                    <div class="form-group">
                        <label>Amount (¬£)</label>
                        <input type="number" id="intTransferAmount" min="0.01" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label>Transfer Reason</label>
                        <select id="transferReason">
                            <option value="">Select reason</option>
                            <option value="family">Family Support</option>
                            <option value="education">Education Fees</option>
                            <option value="property">Property Purchase</option>
                            <option value="investment">Investment</option>
                            <option value="business">Business Payment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Additional Reference</label>
                        <textarea id="intReference" placeholder="Additional details for compliance" rows="2"></textarea>
                    </div>
                </div>
            </div>
            
            <div id="modalTransferAlert" class="alert" style="display: none;"></div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="processModalTransfer()">Continue Transfer</button>
                <button class="btn btn-secondary" onclick="hideModal('transferModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Withdraw Money</h3>
            <div class="form-group">
                <label>Amount (¬£)</label>
                <input type="number" id="withdrawAmount" min="0.01" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Description (Optional)</label>
                <input type="text" id="withdrawDescription" placeholder="e.g., Cash withdrawal">
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="processWithdrawal()">Withdraw</button>
                <button class="btn btn-secondary" onclick="hideModal('withdrawModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin Create Account Modal -->
    <div id="createAccountModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Create User Account (Admin)</h3>
            <div class="info-text">
                Create a new bank account for a customer. An email will be automatically sent to the customer with their account details.
            </div>
            
            <div class="form-group">
                <label>Customer Last Name *</label>
                <input type="text" id="adminLastName" required>
            </div>
            
            <div class="form-group">
                <label>Customer Email Address *</label>
                <input type="email" id="adminEmail" required>
                <small style="color: var(--barclays-gray); margin-top: 5px; display: block;">
                    Account creation email will be sent to this address
                </small>
            </div>
            
            <div class="form-group">
                <label>Date of Birth (DD/MM/YYYY) *</label>
                <div class="date-inputs">
                    <input type="number" id="adminBirthDay" placeholder="DD" min="1" max="31" required>
                    <input type="number" id="adminBirthMonth" placeholder="MM" min="1" max="12" required>
                    <input type="number" id="adminBirthYear" placeholder="YYYY" min="1900" max="2025" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Postcode *</label>
                <input type="text" id="adminPostcode" required>
            </div>
            
            <div class="form-group">
                <label>Account Type *</label>
                <select id="adminAccountType" required>
                    <option value="">Select account type</option>
                    <option value="current">Current Account</option>
                    <option value="savings">Savings Account</option>
                    <option value="business">Business Account</option>
                    <option value="premium">Premium Account</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Initial Deposit Amount (¬£) *</label>
                <input type="number" id="adminInitialDeposit" min="0" step="0.01" value="1000" required>
            </div>
            
            <div class="form-group">
                <label>Temporary Password *</label>
                <input type="text" id="adminTempPassword" value="Welcome123" required>
                <small style="color: var(--barclays-gray); margin-top: 5px; display: block;">
                    Customer will use this password for first login (they should change it)
                </small>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="adminSendWelcomeEmail" checked>
                <label for="adminSendWelcomeEmail" style="font-weight: normal;">
                    Send welcome email with account details to customer
                </label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="adminGenerateCard">
                <label for="adminGenerateCard" style="font-weight: normal;">
                    Generate virtual debit card details
                </label>
            </div>
            
            <div id="adminCreateAlert" class="alert" style="display: none;"></div>
            
            <!-- Email Preview -->
            <div id="emailPreview" class="email-preview hidden">
                <div class="email-header">
                    <h4>Email Preview</h4>
                </div>
                <div class="email-content" id="emailContent">
                    <!-- Email content will be generated here -->
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-success" onclick="previewCustomerEmail()">üìß Preview Email</button>
                <button class="btn btn-primary" onclick="createUserAccount()">Create Account</button>
                <button class="btn btn-secondary" onclick="hideModal('createAccountModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin Transaction Editor Modal -->
    <div id="transactionEditorModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Transaction Management</h3>
            <p>User: <strong id="editorUserName"></strong></p>
            <p>Account: <strong id="editorAccountNumber"></strong></p>
            <p>Current Balance: <strong>¬£<span id="editorCurrentBalance"></span></strong></p>
            
            <div class="transaction-editor">
                <h4>Add/Edit Transaction</h4>
                
                <div class="form-group">
                    <label>Transaction Type</label>
                    <select id="editorTransType">
                        <option value="credit">Credit (Deposit)</option>
                        <option value="debit">Debit (Withdrawal)</option>
                        <option value="transfer_in">Transfer In</option>
                        <option value="transfer_out">Transfer Out</option>
                        <option value="fee">Bank Fee</option>
                        <option value="interest">Interest Payment</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Amount (¬£)</label>
                    <input type="number" id="editorAmount" min="0.01" step="0.01" placeholder="0.00" required>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="editorDescription" placeholder="Transaction description" required>
                </div>
                
                <div class="form-group">
                    <label>Transaction Date</label>
                    <input type="date" id="editorTransDate" required>
                    <small style="color: var(--barclays-gray); margin-top: 5px; display: block;">
                        You can backdate transactions by selecting past dates
                    </small>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="editorNotifyUser" checked>
                    <label for="editorNotifyUser" style="font-weight: normal;">
                        Send transaction notification email to user
                    </label>
                </div>
                
                <div id="editorAlert" class="alert" style="display: none;"></div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="addTransaction()">Add Transaction</button>
                    <button class="btn btn-secondary" onclick="hideModal('transactionEditorModal')">Cancel</button>
                </div>
            </div>
            
            <div class="transaction-editor">
                <h4>Existing Transactions</h4>
                <div class="transaction-list" id="transactionListContainer">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <div class="d-flex">
                    <a href="#">Service status</a>
                    <a href="#">Contact us</a>
                </div>
                <div class="d-flex">
                    <a href="#">Security</a>
                 <a href="#">Accessibility</a>  
                </div>
            </div>
            
            <hr>

            <a href="#" class="mt-4 text-blue">See our cookies policy</a>

            <div class="footer-disclaimer mt-4">
                <p>Barclays Bank UK PLC. Authorised by the Prudential Regulation Authority and regulated by the Financial Conduct Authority and the Prudential Regulation Authority</p><br>
                <p>Barclays Investment Solutions Limited is authorised and regulated by the Financial Conduct Authority.</p><br>
                <p>Registered office for all: 1 Churchill Place, London E14 5HP</p>
            </div>

            <div>
                <img src="./assets/img/bsi_logo_2025.png" alt="">
                <img src="./assets/img/fscs-logo.png" alt="">
                <img src="./assets/img/rolb_cyberessential.png" alt="">
                <img class="mt-1" src="./assets/img/take-five.png" alt="">
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <!-- Firebase and App Logic -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6RIYTsP-F3UhKR5Zuu6F-ok1RTHShEQs",
            authDomain: "barclays-cc823.firebaseapp.com",
            projectId: "barclays-cc823",
            storageBucket: "barclays-cc823.firebasestorage.app",
            messagingSenderId: "770942938167",
            appId: "1:770942938167:web:1cde1cbfd35bd4084e63b2",
            measurementId: "G-BZ8YJ3YQ93"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let currentUserData = null;
        const ADMIN_EMAIL = 'admin@barclaysdemo.com';
        let currentTransferType = 'domestic';
        let editingUserId = null;

        // Page Navigation
        function showRegistration() {
            document.getElementById('registrationSection').classList.remove('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('adminLoginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            resetRegistrationForm();
        }

        function showLogin() {
            document.getElementById('registrationSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('adminLoginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            
            clearLoginForm();
        }

        function clearLoginForm() {
            document.getElementById('loginLastName').value = '';
            document.getElementById('membershipNumber').value = '';
            document.getElementById('membershipPassword').value = '';
            
            document.getElementById('cardLastName').value = '';
            document.getElementById('loginCardNumber').value = '';
            document.getElementById('cardPassword').value = '';
            
            document.getElementById('sortcodeLastName').value = '';
            document.getElementById('loginSortCode').value = '';
            document.getElementById('accountNumber').value = '';
            document.getElementById('sortcodePassword').value = '';
            
            document.getElementById('loginAlert').style.display = 'none';
            
            showLoginMethod('membership');
        }

        function showHomePage() {
            if (currentUser) {
                showDashboard();
            } else {
                showLogin();
            }
        }

        function showAdminLogin() {
            const email = prompt('Enter admin email:');
            const password = prompt('Enter admin password:');
            
            if (email === ADMIN_EMAIL && password === 'admin123') {
                showAdminPanel();
            } else {
                alert('Invalid admin credentials');
            }
        }

        // Registration Form Steps
        function nextStep(step) {
            if (step === 2) {
                if (!validateStep1()) return;
            } else if (step === 3) {
                if (!validateStep2()) return;
            }
            
            document.getElementById('step1Form').classList.add('hidden');
            document.getElementById('step2Form').classList.add('hidden');
            document.getElementById('step3Form').classList.add('hidden');
            
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
            
            document.getElementById('step' + step + 'Form').classList.remove('hidden');
            document.getElementById('step' + step).classList.add('active');
        }

        function prevStep(step) {
            nextStep(step);
        }

        function validateStep1() {
            const lastName = document.getElementById('lastName').value;
            const day = document.getElementById('birthDay').value;
            const month = document.getElementById('birthMonth').value;
            const year = document.getElementById('birthYear').value;
            const postcode = document.getElementById('postcode').value;
            
            if (!lastName || !day || !month || !year || !postcode) {
                alert('Please fill in all required fields');
                return false;
            }
            
            return true;
        }

        function validateStep2() {
            const sortCode = document.getElementById('sortCode').value;
            const cardNumber = document.getElementById('cardNumber').value;
            
            if (!sortCode || !cardNumber) {
                alert('Please fill in all required fields');
                return false;
            }
            
            if (!/^\d{2}-\d{2}-\d{2}$/.test(sortCode)) {
                alert('Please enter a valid sort code (format: 20-00-00)');
                return false;
            }
            
            if (!/^\d{16}$/.test(cardNumber)) {
                alert('Please enter a valid 16-digit card number');
                return false;
            }
            
            return true;
        }

        function cancelRegistration() {
            if (confirm('Are you sure you want to cancel registration?')) {
                showLogin();
            }
        }

        // User Registration
        async function registerUser() {
            const lastName = document.getElementById('lastName').value;
            const day = document.getElementById('birthDay').value;
            const month = document.getElementById('birthMonth').value;
            const year = document.getElementById('birthYear').value;
            const postcode = document.getElementById('postcode').value;
            const accountType = document.querySelector('input[name="accountType"]:checked').value;
            const sortCode = document.getElementById('sortCode').value;
            const cardNumber = document.getElementById('cardNumber').value;
            const email = document.getElementById('email').value;
            const confirmEmail = document.getElementById('confirmEmail').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const marketingOptIn = document.getElementById('marketingOptIn').checked;
            
            if (email !== confirmEmail) {
                showAlert('registerAlert', 'Email addresses do not match', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('registerAlert', 'Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAlert('registerAlert', 'Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Generate account details
                const accountData = generateAccountDetails(accountType, lastName);
                
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    lastName: lastName,
                    dateOfBirth: `${day}/${month}/${year}`,
                    postcode: postcode,
                    email: email,
                    accountType: accountType,
                    sortCode: sortCode,
                    cardNumber: cardNumber,
                    accountNumber: accountData.accountNumber,
                    membershipNumber: accountData.membershipNumber,
                    iban: accountData.iban,
                    swift: accountData.swift,
                    balance: accountData.balance,
                    marketingOptIn: marketingOptIn,
                    isAdmin: email === ADMIN_EMAIL,
                    createdBy: 'self',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    transactions: [
                        {
                            date: new Date().toISOString(),
                            description: 'Account Opening Deposit',
                            amount: accountData.balance,
                            balance: accountData.balance,
                            type: 'credit',
                            reference: 'ACCOUNT_OPENING',
                            processedBy: 'system'
                        }
                    ]
                });
                
                // Log admin activity
                await logAdminActivity('USER_SELF_REGISTER', {
                    userId: user.uid,
                    email: email,
                    accountNumber: accountData.accountNumber
                });
                
                showAlert('registerAlert', 'Registration successful! Loading your dashboard...', 'success');
                
                resetRegistrationForm();
                
            } catch (error) {
                showAlert('registerAlert', error.message, 'error');
            }
        }

        // Login Methods
        function showLoginMethod(method) {
            document.querySelectorAll('.login-option').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('membershipLogin').classList.add('hidden');
            document.getElementById('cardLogin').classList.add('hidden');
            document.getElementById('sortcodeLogin').classList.add('hidden');
            
            document.getElementById(method + 'Login').classList.remove('hidden');
        }

        async function loginWithMembership() {
            const lastName = document.getElementById('loginLastName').value;
            const membershipNumber = document.getElementById('membershipNumber').value;
            const password = document.getElementById('membershipPassword').value;
            
            if (!lastName || !membershipNumber || !password) {
                showAlert('loginAlert', 'Please fill in all required fields', 'error');
                return;
            }
            
            if (!/^\d{12}$/.test(membershipNumber)) {
                showAlert('loginAlert', 'Please enter a valid 12-digit membership number', 'error');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('membershipNumber', '==', membershipNumber)
                    .where('lastName', '==', lastName)
                    .get();
                
                if (usersSnapshot.empty) {
                    showAlert('loginAlert', 'Invalid membership number or last name', 'error');
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                const userData = userDoc.data();
                
                await auth.signInWithEmailAndPassword(userData.email, password);
                
            } catch (error) {
                showAlert('loginAlert', error.message, 'error');
            }
        }

        async function loginWithCard() {
            const lastName = document.getElementById('cardLastName').value;
            const cardNumber = document.getElementById('loginCardNumber').value;
            const password = document.getElementById('cardPassword').value;
            
            if (!lastName || !cardNumber || !password) {
                showAlert('loginAlert', 'Please fill in all required fields', 'error');
                return;
            }
            
            if (!/^\d{16}$/.test(cardNumber)) {
                showAlert('loginAlert', 'Please enter a valid 16-digit card number', 'error');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('cardNumber', '==', cardNumber)
                    .where('lastName', '==', lastName)
                    .get();
                
                if (usersSnapshot.empty) {
                    showAlert('loginAlert', 'Invalid card number or last name', 'error');
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                const userData = userDoc.data();
                
                await auth.signInWithEmailAndPassword(userData.email, password);
                
            } catch (error) {
                showAlert('loginAlert', error.message, 'error');
            }
        }

        async function loginWithSortcode() {
            const lastName = document.getElementById('sortcodeLastName').value;
            const sortCode = document.getElementById('loginSortCode').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const password = document.getElementById('sortcodePassword').value;
            
            if (!lastName || !sortCode || !accountNumber || !password) {
                showAlert('loginAlert', 'Please fill in all required fields', 'error');
                return;
            }
            
            if (!/^\d{2}-\d{2}-\d{2}$/.test(sortCode)) {
                showAlert('loginAlert', 'Please enter a valid sort code (format: 20-00-00)', 'error');
                return;
            }
            
            if (!/^\d{8}$/.test(accountNumber)) {
                showAlert('loginAlert', 'Please enter a valid 8-digit account number', 'error');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('sortCode', '==', sortCode)
                    .where('accountNumber', '==', accountNumber)
                    .where('lastName', '==', lastName)
                    .get();
                
                if (usersSnapshot.empty) {
                    showAlert('loginAlert', 'Invalid account details', 'error');
                    return;
                }
                
                const userDoc = usersSnapshot.docs[0];
                const userData = userDoc.data();
                
                await auth.signInWithEmailAndPassword(userData.email, password);
                
            } catch (error) {
                showAlert('loginAlert', error.message, 'error');
            }
        }

        // Dashboard Functions
        async function showDashboard() {
            if (!currentUserData) return;
            
            document.getElementById('registrationSection').classList.add('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('adminLoginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            
            // Update dashboard data
            document.getElementById('welcomeName').textContent = currentUserData.lastName;
            document.getElementById('dashboardAccountNumber').textContent = currentUserData.accountNumber;
            document.getElementById('currentBalance').textContent = currentUserData.balance.toFixed(2);
            document.getElementById('accountTypeDisplay').textContent = currentUserData.accountType.charAt(0).toUpperCase() + currentUserData.accountType.slice(1);
            document.getElementById('cardNumberDisplay').textContent = currentUserData.cardNumber;
            
            // Update account details card
            document.getElementById('accountHolderName').textContent = currentUserData.lastName;
            document.getElementById('fullAccountNumber').textContent = currentUserData.accountNumber;
            document.getElementById('fullSortCode').textContent = currentUserData.sortCode;
            document.getElementById('ibanNumber').textContent = currentUserData.iban || 'GB29BARC' + Math.floor(10000000000000 + Math.random() * 90000000000000).toString();
            document.getElementById('swiftCode').textContent = currentUserData.swift || 'BARCGB22';
            
            loadTransactions();
        }

        async function loadTransactions() {
            if (!currentUserData) return;
            
            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '';
            
            if (currentUserData.transactions && currentUserData.transactions.length > 0) {
                // Sort transactions by date (newest first)
                const sortedTransactions = [...currentUserData.transactions].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                sortedTransactions.forEach(trans => {
                    const row = `
                        <tr>
                            <td>${new Date(trans.date).toLocaleDateString()}</td>
                            <td>${trans.description}${trans.reference ? ` (${trans.reference})` : ''}</td>
                            <td style="color: ${trans.type === 'credit' || trans.type === 'transfer_in' || trans.type === 'interest' ? 'green' : 'red'}">
                                ${trans.type === 'credit' || trans.type === 'transfer_in' || trans.type === 'interest' ? '+' : '-'}¬£${Math.abs(trans.amount).toFixed(2)}
                            </td>
                            <td>¬£${trans.balance.toFixed(2)}</td>
                        </tr>
                    `;
                    transactionList.innerHTML += row;
                });
            } else {
                transactionList.innerHTML = '<tr><td colspan="4">No transactions found</td></tr>';
            }
        }

        // Generate Account Details Function
        function generateAccountDetails(accountType, lastName) {
            const accountNumber = '20' + Math.floor(100000 + Math.random() * 900000);
            const membershipNumber = Math.floor(100000000000 + Math.random() * 900000000000).toString();
            const iban = 'GB29BARC' + Math.floor(10000000000000 + Math.random() * 90000000000000).toString();
            const swift = 'BARCGB22';
            
            // Set initial balance based on account type
            let balance;
            switch(accountType) {
                case 'current':
                    balance = 1000;
                    break;
                case 'savings':
                    balance = 5000;
                    break;
                case 'business':
                    balance = 10000;
                    break;
                case 'premium':
                    balance = 25000;
                    break;
                case 'mortgage':
                    balance = -150000;
                    break;
                default:
                    balance = 1000;
            }
            
            return {
                accountNumber,
                membershipNumber,
                iban,
                swift,
                balance
            };
        }

        // Admin Functions
        async function showAdminPanel() {
            document.getElementById('registrationSection').classList.add('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            document.getElementById('adminLoginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            
            await loadAllUsers();
        }

        // Show Create Account Modal
        function showCreateAccountModal() {
            document.getElementById('createAccountModal').classList.remove('hidden');
            document.getElementById('adminCreateAlert').style.display = 'none';
            document.getElementById('emailPreview').classList.add('hidden');
            
            // Set default values
            document.getElementById('adminLastName').value = '';
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminBirthDay').value = '';
            document.getElementById('adminBirthMonth').value = '';
            document.getElementById('adminBirthYear').value = '';
            document.getElementById('adminPostcode').value = '';
            document.getElementById('adminAccountType').value = '';
            document.getElementById('adminInitialDeposit').value = '1000';
            document.getElementById('adminTempPassword').value = 'Welcome123';
            document.getElementById('adminSendWelcomeEmail').checked = true;
            document.getElementById('adminGenerateCard').checked = true;
        }

        // Preview Customer Email
        function previewCustomerEmail() {
            const lastName = document.getElementById('adminLastName').value;
            const email = document.getElementById('adminEmail').value;
            const accountType = document.getElementById('adminAccountType').value;
            const initialDeposit = document.getElementById('adminInitialDeposit').value;
            
            if (!lastName || !email || !accountType) {
                alert('Please fill in required fields first');
                return;
            }
            
            // Generate sample account details for preview
            const accountData = generateAccountDetails(accountType, lastName);
            
            const emailContent = `
                <p><strong>Subject:</strong> Welcome to Barclays - Your New Account Details</p>
                <hr>
                <p>Dear ${lastName},</p>
                <p>Welcome to Barclays! Your new ${accountType} account has been successfully created.</p>
                <p>Here are your account details:</p>
                <ul>
                    <li><strong>Account Holder:</strong> ${lastName}</li>
                    <li><strong>Account Number:</strong> ${accountData.accountNumber}</li>
                    <li><strong>Sort Code:</strong> 20-00-00</li>
                    <li><strong>Account Type:</strong> ${accountType.charAt(0).toUpperCase() + accountType.slice(1)} Account</li>
                    <li><strong>Initial Deposit:</strong> ¬£${parseFloat(initialDeposit).toFixed(2)}</li>
                    <li><strong>Temporary Password:</strong> ${document.getElementById('adminTempPassword').value}</li>
                </ul>
                <p><strong>Important:</strong> For security reasons, please change your password on first login.</p>
                <p>You can access your account at: <a href="#">https://onlinebanking.barclays.co.uk</a></p>
                <p>If you have any questions, please contact our customer service at 0800 123 4567.</p>
                <p>Best regards,<br>Barclays Bank</p>
            `;
            
            document.getElementById('emailContent').innerHTML = emailContent;
            document.getElementById('emailPreview').classList.remove('hidden');
        }

        // Create User Account (Admin)
        async function createUserAccount() {
            const lastName = document.getElementById('adminLastName').value;
            const email = document.getElementById('adminEmail').value;
            const day = document.getElementById('adminBirthDay').value;
            const month = document.getElementById('adminBirthMonth').value;
            const year = document.getElementById('adminBirthYear').value;
            const postcode = document.getElementById('adminPostcode').value;
            const accountType = document.getElementById('adminAccountType').value;
            const initialDeposit = parseFloat(document.getElementById('adminInitialDeposit').value);
            const tempPassword = document.getElementById('adminTempPassword').value;
            const sendWelcomeEmail = document.getElementById('adminSendWelcomeEmail').checked;
            const generateCard = document.getElementById('adminGenerateCard').checked;
            
            // Validation
            if (!lastName || !email || !day || !month || !year || !postcode || !accountType || !tempPassword) {
                showAlert('adminCreateAlert', 'Please fill in all required fields', 'error');
                return;
            }
            
            if (initialDeposit < 0) {
                showAlert('adminCreateAlert', 'Initial deposit cannot be negative', 'error');
                return;
            }
            
            if (tempPassword.length < 6) {
                showAlert('adminCreateAlert', 'Temporary password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                // Create Firebase Auth user
                const userCredential = await auth.createUserWithEmailAndPassword(email, tempPassword);
                const user = userCredential.user;
                
                // Generate account details
                const accountData = generateAccountDetails(accountType, lastName);
                accountData.balance = initialDeposit;
                
                // Generate card number if requested
                const cardNumber = generateCard ? Math.floor(1000000000000000 + Math.random() * 9000000000000000).toString() : 'PENDING';
                const sortCode = generateCard ? '20-00-00' : 'PENDING';
                
                // Create user document
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    lastName: lastName,
                    dateOfBirth: `${day}/${month}/${year}`,
                    postcode: postcode,
                    email: email,
                    accountType: accountType,
                    sortCode: sortCode,
                    cardNumber: cardNumber,
                    accountNumber: accountData.accountNumber,
                    membershipNumber: accountData.membershipNumber,
                    iban: accountData.iban,
                    swift: accountData.swift,
                    balance: accountData.balance,
                    marketingOptIn: false,
                    isAdmin: false,
                    createdBy: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    transactions: [
                        {
                            date: new Date().toISOString(),
                            description: 'Account Opening - Initial Deposit',
                            amount: accountData.balance,
                            balance: accountData.balance,
                            type: 'credit',
                            reference: 'ADMIN_CREATED',
                            processedBy: currentUser.email
                        }
                    ],
                    requiresPasswordChange: true
                });
                
                // Log admin activity
                await logAdminActivity('ACCOUNT_CREATED', {
                    adminId: currentUser.uid,
                    adminEmail: currentUser.email,
                    userId: user.uid,
                    userEmail: email,
                    accountNumber: accountData.accountNumber,
                    accountType: accountType,
                    initialDeposit: initialDeposit
                });
                
                // Send welcome email if requested
                if (sendWelcomeEmail) {
                    await sendWelcomeEmailToUser({
                        email: email,
                        lastName: lastName,
                        accountNumber: accountData.accountNumber,
                        accountType: accountType,
                        initialDeposit: initialDeposit,
                        tempPassword: tempPassword,
                        sortCode: sortCode,
                        cardNumber: cardNumber,
                        iban: accountData.iban,
                        swift: accountData.swift
                    });
                }
                
                showAlert('adminCreateAlert', `Account created successfully for ${lastName}! ${sendWelcomeEmail ? 'Welcome email sent.' : ''}`, 'success');
                
                // Refresh user list
                await loadAllUsers();
                
                // Clear form after 2 seconds
                setTimeout(() => {
                    hideModal('createAccountModal');
                }, 2000);
                
            } catch (error) {
                showAlert('adminCreateAlert', 'Error creating account: ' + error.message, 'error');
            }
        }

        // Send Welcome Email (Simulated)
        async function sendWelcomeEmailToUser(userData) {
            // In a real app, you would use a backend service like SendGrid, Mailgun, etc.
            // For demo purposes, we'll log it and show a success message
            
            const emailLog = {
                to: userData.email,
                subject: `Welcome to Barclays - Your New ${userData.accountType} Account`,
                body: `
Dear ${userData.lastName},

Welcome to Barclays! Your new account has been successfully created.

Account Details:
- Account Holder: ${userData.lastName}
- Account Number: ${userData.accountNumber}
- Sort Code: ${userData.sortCode}
- Account Type: ${userData.accountType}
- Initial Balance: ¬£${userData.initialDeposit.toFixed(2)}
- Temporary Password: ${userData.tempPassword}
${userData.cardNumber !== 'PENDING' ? `- Debit Card: **** **** **** ${userData.cardNumber.slice(-4)}` : ''}
- IBAN: ${userData.iban}
- SWIFT/BIC: ${userData.swift}

Important Security Notes:
1. Please change your password on first login
2. Keep your account details secure
3. Never share your password with anyone

You can access your account at: https://onlinebanking.barclays.co.uk

If you have any questions, please contact us at 0800 123 4567.

Best regards,
Barclays Bank
                `,
                sentAt: new Date().toISOString(),
                sentBy: currentUser.email
            };
            
            // Save email log to Firestore
            await db.collection('email_logs').add(emailLog);
            
            // Log admin activity
            await logAdminActivity('WELCOME_EMAIL_SENT', {
                adminId: currentUser.uid,
                adminEmail: currentUser.email,
                recipientEmail: userData.email,
                accountNumber: userData.accountNumber
            });
            
            console.log('Welcome email sent to:', userData.email);
            return true;
        }

        // Load All Users for Admin
        async function loadAllUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const usersList = document.getElementById('adminUsersList');
                usersList.innerHTML = '';
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const row = `
                        <tr>
                            <td>${user.lastName}</td>
                            <td>${user.email}</td>
                            <td>${user.accountType || 'N/A'}</td>
                            <td>${user.sortCode || 'N/A'}</td>
                            <td>${user.cardNumber || 'N/A'}</td>
                            <td>${user.accountNumber || 'N/A'}</td>
                            <td>
                                ¬£${user.balance?.toFixed(2) || '0.00'}
                                <div class="balance-edit">
                                    <input type="number" id="editBalance_${doc.id}" placeholder="New balance" step="0.01">
                                    <button class="btn btn-sm btn-success" onclick="updateUserBalance('${doc.id}')">Update</button>
                                </div>
                            </td>
                            <td>
                                <div class="transaction-actions">
                                    <button class="btn btn-sm btn-primary" onclick="manageUserTransactions('${doc.id}')">üí≥ Transactions</button>
                                    <button class="btn btn-sm btn-warning" onclick="viewUserDetails('${doc.id}')">üëÅÔ∏è View</button>
                                    ${user.isAdmin ? '<span class="btn btn-sm btn-secondary">Admin</span>' : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                    usersList.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Manage User Transactions
        async function manageUserTransactions(userId) {
            editingUserId = userId;
            
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                
                // Update modal info
                document.getElementById('editorUserName').textContent = userData.lastName;
                document.getElementById('editorAccountNumber').textContent = userData.accountNumber;
                document.getElementById('editorCurrentBalance').textContent = userData.balance.toFixed(2);
                
                // Set default date to today
                document.getElementById('editorTransDate').valueAsDate = new Date();
                
                // Load existing transactions
                await loadUserTransactions(userId);
                
                // Show modal
                document.getElementById('transactionEditorModal').classList.remove('hidden');
                
            } catch (error) {
                alert('Error loading user data: ' + error.message);
            }
        }

        // Load User Transactions for Editing
        async function loadUserTransactions(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                const transactions = userData.transactions || [];
                
                const container = document.getElementById('transactionListContainer');
                container.innerHTML = '';
                
                if (transactions.length === 0) {
                    container.innerHTML = '<p>No transactions found</p>';
                    return;
                }
                
                // Sort by date (newest first)
                const sortedTransactions = [...transactions].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                sortedTransactions.forEach((trans, index) => {
                    const transItem = document.createElement('div');
                    transItem.className = 'transaction-item';
                    transItem.innerHTML = `
                        <div>
                            <strong>${new Date(trans.date).toLocaleDateString()}</strong><br>
                            ${trans.description}<br>
                            <small>Type: ${trans.type} | Ref: ${trans.reference || 'N/A'}</small>
                        </div>
                        <div>
                            <span style="color: ${trans.type === 'credit' || trans.type === 'transfer_in' || trans.type === 'interest' ? 'green' : 'red'}; font-weight: bold;">
                                ${trans.type === 'credit' || trans.type === 'transfer_in' || trans.type === 'interest' ? '+' : '-'}¬£${Math.abs(trans.amount).toFixed(2)}
                            </span><br>
                            <small>Balance: ¬£${trans.balance.toFixed(2)}</small>
                        </div>
                        <div class="transaction-actions">
                            <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${index})">üóëÔ∏è</button>
                        </div>
                    `;
                    container.appendChild(transItem);
                });
                
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        // Add Transaction (Admin)
        async function addTransaction() {
            if (!editingUserId) return;
            
            const type = document.getElementById('editorTransType').value;
            const amount = parseFloat(document.getElementById('editorAmount').value);
            const description = document.getElementById('editorDescription').value;
            const transDate = document.getElementById('editorTransDate').value;
            const notifyUser = document.getElementById('editorNotifyUser').checked;
            
            if (!amount || amount <= 0) {
                showAlert('editorAlert', 'Please enter a valid amount', 'error');
                return;
            }
            
            if (!description) {
                showAlert('editorAlert', 'Please enter a description', 'error');
                return;
            }
            
            if (!transDate) {
                showAlert('editorAlert', 'Please select a date', 'error');
                return;
            }
            
            try {
                // Get current user data
                const userDoc = await db.collection('users').doc(editingUserId).get();
                const userData = userDoc.data();
                
                // Calculate new balance
                let newBalance = userData.balance;
                if (type === 'credit' || type === 'transfer_in' || type === 'interest') {
                    newBalance += amount;
                } else {
                    newBalance -= amount;
                }
                
                // Create transaction object
                const transaction = {
                    date: new Date(transDate).toISOString(),
                    description: description,
                    amount: type === 'credit' || type === 'transfer_in' || type === 'interest' ? amount : -amount,
                    balance: newBalance,
                    type: type,
                    reference: 'ADMIN_ADJUSTMENT',
                    processedBy: currentUser.email,
                    processedAt: new Date().toISOString()
                };
                
                // Update user document
                await db.collection('users').doc(editingUserId).update({
                    balance: newBalance,
                    transactions: firebase.firestore.FieldValue.arrayUnion(transaction)
                });
                
                // Log admin activity
                await logAdminActivity('TRANSACTION_ADDED', {
                    adminId: currentUser.uid,
                    adminEmail: currentUser.email,
                    userId: editingUserId,
                    userEmail: userData.email,
                    transactionType: type,
                    amount: amount,
                    description: description,
                    transactionDate: transDate,
                    newBalance: newBalance
                });
                
                // Send notification email if requested
                if (notifyUser) {
                    await sendTransactionNotification(userData, transaction);
                }
                
                showAlert('editorAlert', 'Transaction added successfully!', 'success');
                
                // Clear form
                document.getElementById('editorAmount').value = '';
                document.getElementById('editorDescription').value = '';
                document.getElementById('editorTransDate').valueAsDate = new Date();
                
                // Refresh data
                await loadUserTransactions(editingUserId);
                
                // Update current balance display
                document.getElementById('editorCurrentBalance').textContent = newBalance.toFixed(2);
                
                // Refresh main user list
                await loadAllUsers();
                
            } catch (error) {
                showAlert('editorAlert', 'Error adding transaction: ' + error.message, 'error');
            }
        }

        // Delete Transaction (Admin)
        async function deleteTransaction(index) {
            if (!editingUserId || !confirm('Are you sure you want to delete this transaction? This cannot be undone.')) {
                return;
            }
            
            try {
                const userDoc = await db.collection('users').doc(editingUserId).get();
                const userData = userDoc.data();
                const transactions = userData.transactions || [];
                
                if (index < 0 || index >= transactions.length) {
                    alert('Invalid transaction index');
                    return;
                }
                
                // Remove transaction from array
                const transactionToDelete = transactions[index];
                const updatedTransactions = transactions.filter((_, i) => i !== index);
                
                // Recalculate balance
                let newBalance = userData.balance;
                if (transactionToDelete.type === 'credit' || transactionToDelete.type === 'transfer_in' || transactionToDelete.type === 'interest') {
                    newBalance -= transactionToDelete.amount;
                } else {
                    newBalance += Math.abs(transactionToDelete.amount);
                }
                
                // Update user document
                await db.collection('users').doc(editingUserId).update({
                    balance: newBalance,
                    transactions: updatedTransactions
                });
                
                // Log admin activity
                await logAdminActivity('TRANSACTION_DELETED', {
                    adminId: currentUser.uid,
                    adminEmail: currentUser.email,
                    userId: editingUserId,
                    userEmail: userData.email,
                    transactionIndex: index,
                    transactionAmount: transactionToDelete.amount,
                    transactionDescription: transactionToDelete.description,
                    newBalance: newBalance
                });
                
                // Refresh data
                await loadUserTransactions(editingUserId);
                document.getElementById('editorCurrentBalance').textContent = newBalance.toFixed(2);
                
                alert('Transaction deleted successfully!');
                
            } catch (error) {
                alert('Error deleting transaction: ' + error.message);
            }
        }

        // Send Transaction Notification Email
        async function sendTransactionNotification(userData, transaction) {
            const emailLog = {
                to: userData.email,
                subject: `Barclays Account Update - Transaction ${transaction.type === 'credit' || transaction.type === 'transfer_in' || transaction.type === 'interest' ? 'Credit' : 'Debit'}`,
                body: `
Dear ${userData.lastName},

A transaction has been processed on your account.

Transaction Details:
- Date: ${new Date(transaction.date).toLocaleDateString()}
- Description: ${transaction.description}
- Amount: ${transaction.type === 'credit' || transaction.type === 'transfer_in' || transaction.type === 'interest' ? '+' : '-'}¬£${Math.abs(transaction.amount).toFixed(2)}
- Type: ${transaction.type.toUpperCase()}
- Reference: ${transaction.reference}
- New Balance: ¬£${transaction.balance.toFixed(2)}
- Processed By: ${transaction.processedBy}

If you did not authorize this transaction or have any questions, please contact us immediately at 0800 123 4567.

Best regards,
Barclays Bank
                `,
                sentAt: new Date().toISOString(),
                sentBy: currentUser.email,
                transactionId: transaction.date + '_' + transaction.amount
            };
            
            // Save email log to Firestore
            await db.collection('email_logs').add(emailLog);
            
            console.log('Transaction notification sent to:', userData.email);
            return true;
        }

        // View User Details
        async function viewUserDetails(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                
                let details = `User Details:\n`;
                details += `Name: ${userData.lastName}\n`;
                details += `Email: ${userData.email}\n`;
                details += `Account: ${userData.accountNumber}\n`;
                details += `Type: ${userData.accountType}\n`;
                details += `Balance: ¬£${userData.balance?.toFixed(2) || '0.00'}\n`;
                details += `Created: ${userData.createdAt?.toDate().toLocaleString() || 'N/A'}\n`;
                details += `Created By: ${userData.createdBy || 'Self'}\n`;
                details += `Last Login: ${userData.lastLogin?.toDate().toLocaleString() || 'Never'}\n`;
                details += `Transactions: ${userData.transactions?.length || 0}`;
                
                alert(details);
                
            } catch (error) {
                alert('Error loading user details: ' + error.message);
            }
        }

        // Update User Balance
        async function updateUserBalance(userId) {
            const newBalanceInput = document.getElementById(`editBalance_${userId}`);
            const newBalance = parseFloat(newBalanceInput.value);
            
            if (!newBalance || isNaN(newBalance)) {
                alert('Please enter a valid balance');
                return;
            }
            
            if (!confirm(`Are you sure you want to change this user's balance to ¬£${newBalance.toFixed(2)}?`)) {
                return;
            }
            
            try {
                // Get current user data
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                const oldBalance = userData.balance;
                
                // Create adjustment transaction
                const adjustmentAmount = newBalance - oldBalance;
                const transaction = {
                    date: new Date().toISOString(),
                    description: 'Balance Adjustment',
                    amount: adjustmentAmount,
                    balance: newBalance,
                    type: adjustmentAmount >= 0 ? 'credit' : 'debit',
                    reference: 'BALANCE_ADJUSTMENT',
                    processedBy: currentUser.email,
                    processedAt: new Date().toISOString()
                };
                
                // Update user document
                await db.collection('users').doc(userId).update({
                    balance: newBalance,
                    transactions: firebase.firestore.FieldValue.arrayUnion(transaction)
                });
                
                // Log admin activity
                await logAdminActivity('BALANCE_UPDATED', {
                    adminId: currentUser.uid,
                    adminEmail: currentUser.email,
                    userId: userId,
                    userEmail: userData.email,
                    oldBalance: oldBalance,
                    newBalance: newBalance,
                    adjustmentAmount: adjustmentAmount
                });
                
                // Send notification email
                await sendBalanceAdjustmentNotification(userData, oldBalance, newBalance, adjustmentAmount);
                
                alert('Balance updated successfully! Notification sent to user.');
                await loadAllUsers();
                
            } catch (error) {
                alert('Error updating balance: ' + error.message);
            }
        }

        // Send Balance Adjustment Notification
        async function sendBalanceAdjustmentNotification(userData, oldBalance, newBalance, adjustmentAmount) {
            const emailLog = {
                to: userData.email,
                subject: 'Barclays Account Update - Balance Adjustment',
                body: `
Dear ${userData.lastName},

Your account balance has been adjusted.

Adjustment Details:
- Previous Balance: ¬£${oldBalance.toFixed(2)}
- Adjustment Amount: ${adjustmentAmount >= 0 ? '+' : ''}¬£${adjustmentAmount.toFixed(2)}
- New Balance: ¬£${newBalance.toFixed(2)}
- Date: ${new Date().toLocaleDateString()}
- Processed By: ${currentUser.email}
- Reference: BALANCE_ADJUSTMENT

If you have any questions about this adjustment, please contact us at 0800 123 4567.

Best regards,
Barclays Bank
                `,
                sentAt: new Date().toISOString(),
                sentBy: currentUser.email
            };
            
            // Save email log to Firestore
            await db.collection('email_logs').add(emailLog);
            
            console.log('Balance adjustment notification sent to:', userData.email);
            return true;
        }

        // Log Admin Activity
        async function logAdminActivity(action, details) {
            try {
                await db.collection('admin_logs').add({
                    adminId: currentUser.uid,
                    adminEmail: currentUser.email,
                    action: action,
                    details: details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ipAddress: 'N/A' // In real app, get from request
                });
            } catch (error) {
                console.error('Error logging admin activity:', error);
            }
        }

        // View System Logs
        async function viewSystemLogs() {
            try {
                const logsSnapshot = await db.collection('admin_logs')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                let logsHTML = '<h3>Recent System Logs (Last 50)</h3><table class="user-table"><thead><tr><th>Time</th><th>Admin</th><th>Action</th><th>Details</th></tr></thead><tbody>';
                
                if (logsSnapshot.empty) {
                    logsHTML += '<tr><td colspan="4">No logs found</td></tr>';
                } else {
                    logsSnapshot.forEach(doc => {
                        const log = doc.data();
                        logsHTML += `
                            <tr>
                                <td>${log.timestamp?.toDate().toLocaleString() || 'N/A'}</td>
                                <td>${log.adminEmail || 'N/A'}</td>
                                <td>${log.action || 'N/A'}</td>
                                <td><small>${JSON.stringify(log.details || {})}</small></td>
                            </tr>
                        `;
                    });
                }
                
                logsHTML += '</tbody></table>';
                
                const modalHTML = `
                    <div class="modal-overlay">
                        <div class="modal" style="max-width: 1000px; max-height: 80vh; overflow-y: auto;">
                            ${logsHTML}
                            <div style="margin-top: 20px; text-align: center;">
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                alert('Error loading system logs: ' + error.message);
            }
        }

        // Refresh Admin Users
        function refreshAdminUsers() {
            loadAllUsers();
            alert('User list refreshed!');
        }

        // Export Users to CSV
        function exportUsersToCSV() {
            const rows = document.querySelectorAll('#adminUsersList tr');
            let csv = 'Last Name,Email,Account Type,Sort Code,Card Number,Account Number,Balance\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).slice(0, 7).map(cell => {
                    let text = cell.textContent.trim();
                    if (text.includes('Update')) {
                        text = text.split('Update')[0].trim();
                        text = text.replace('¬£', '').trim();
                    }
                    text = text.replace(/,/g, '');
                    if (text.includes(' ') || text.includes('"')) {
                        text = `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                }).join(',');
                csv += rowData + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'barclays-users-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            alert('CSV export started!');
        }

        // Hide Modal
        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Logout Admin
        function logoutAdmin() {
            auth.signOut();
        }

        // Utility Functions
        function showAlert(elementId, message, type = 'success') {
            const alertDiv = document.getElementById(elementId);
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function resetRegistrationForm() {
            document.getElementById('lastName').value = '';
            document.getElementById('birthDay').value = '';
            document.getElementById('birthMonth').value = '';
            document.getElementById('birthYear').value = '';
            document.getElementById('postcode').value = '';
            document.getElementById('sortCode').value = '';
            document.getElementById('cardNumber').value = '';
            document.getElementById('email').value = '';
            document.getElementById('confirmEmail').value = '';
            document.getElementById('password').value = '';
            document.getElementById('confirmPassword').value = '';
            
            nextStep(1);
        }

        function logoutUser() {
            auth.signOut();
            currentUser = null;
            currentUserData = null;
            showLogin();
        }

        // Firebase Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                        
                        // Update last login timestamp
                        await db.collection('users').doc(user.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Check if admin
                        if (currentUserData.isAdmin) {
                            showAdminPanel();
                        } else {
                            showDashboard();
                        }
                    } else {
                        // Create account for new admin users
                        const accountData = generateAccountDetails('current', 'User');
                        
                        await db.collection('users').doc(user.uid).set({
                            uid: user.uid,
                            lastName: 'User',
                            email: user.email,
                            accountType: 'current',
                            sortCode: '20-00-00',
                            cardNumber: Math.floor(1000000000000000 + Math.random() * 9000000000000000).toString(),
                            accountNumber: accountData.accountNumber,
                            membershipNumber: accountData.membershipNumber,
                            iban: accountData.iban,
                            swift: accountData.swift,
                            balance: 1000,
                            isAdmin: user.email === ADMIN_EMAIL,
                            createdBy: 'system',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                            transactions: []
                        });
                        
                        const newUserDoc = await db.collection('users').doc(user.uid).get();
                        currentUserData = newUserDoc.data();
                        
                        if (currentUserData.isAdmin) {
                            showAdminPanel();
                        } else {
                            showDashboard();
                        }
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    auth.signOut();
                    showLogin();
                }
            } else {
                currentUser = null;
                currentUserData = null;
                showLogin();
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            showLogin();
            
            // Admin user creation function
            window.createAdminUser = async function() {
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(ADMIN_EMAIL, 'admin123');
                    const user = userCredential.user;
                    
                    const accountData = generateAccountDetails('admin', 'Administrator');
                    
                    await db.collection('users').doc(user.uid).set({
                        uid: user.uid,
                        lastName: 'Administrator',
                        email: ADMIN_EMAIL,
                        accountType: 'admin',
                        sortCode: '99-99-99',
                        cardNumber: '9999999999999999',
                        accountNumber: accountData.accountNumber,
                        membershipNumber: accountData.membershipNumber,
                        iban: accountData.iban,
                        swift: accountData.swift,
                        balance: 0,
                        isAdmin: true,
                        createdBy: 'system',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        transactions: []
                    });
                    
                    console.log('Admin user created! Please log in with:', ADMIN_EMAIL, 'and password: admin123');
                    await auth.signOut();
                    showLogin();
                } catch (error) {
                    console.error('Error creating admin:', error);
                }
            };
        });

        // Include existing functions from previous code (abbreviated for space)
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard: ' + text);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function showAccountDetailsReceipt() {
            // ... existing code ...
        }

        function printReceipt() {
            // ... existing code ...
        }

        function closeReceipt() {
            // ... existing code ...
        }

        function requestATMCard() {
            // ... existing code ...
        }

        function showTransferModal() {
            // ... existing code ...
        }

        function selectTransferType(type) {
            // ... existing code ...
        }

        function processModalTransfer() {
            // ... existing code ...
        }

        function showWithdrawModal() {
            // ... existing code ...
        }

        function processWithdrawal() {
            // ... existing code ...
        }

        function showStatements() {
            alert('Statement feature coming soon. Please contact your account manager for statements.');
        }
    </script>
</body>
</html>